<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>NOVOTECH – Подбор трековой системы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Общие стили для novotech.html */
    html, body {
      margin: 0;
      padding: 0;
      background-color: #e7f5fd;
      overflow: visible;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background-color: white;
      padding: 20px;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      height: auto;
      overflow: visible;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      table-layout: auto;
    }
    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
      font-size: 13px;
    }
    .results-table th {
      background-color: #f4f4f4;
      font-weight: bold;
    }
    .results-table th:nth-child(3),
    .results-table td:nth-child(3) {
      width: 90px;
    }
    .results-table th:nth-child(2),
    .results-table td:nth-child(2) {
      width: 40px;
      text-align: center;
    }
    .total-price {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
      font-size: 14px;
    }
    .result-container {
      display: none;
      overflow: visible;
    }
    .debug {
      font-size: 12px;
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Контейнер для вывода результатов подбора -->
    <div id="resultContainer" class="result-container">
      <table class="results-table" id="resultsTable">
        <thead id="tableHeader">
          <tr>
            <th>Наименование</th>
            <th>кол.</th>
            <th>Цена за шт.</th>
            <th>Общая цена</th>
          </tr>
        </thead>
        <tbody id="results">
          <!-- Результаты подбора будут выведены здесь -->
        </tbody>
      </table>
      <div id="totalPrice" class="total-price"></div>
    </div>
    <div id="debug" class="debug"></div>
  </div>
  
  <script>
    /***** Глобальная переменная для подвесов NOVOTECH *****/
    var suspensionMapping = {
      "135152": { "name": "Подвес черный NOVOTECH", "price": 430, "image": "images/novotech/135152.png" },
      "135151": { "name": "Подвес белый NOVOTECH", "price": 430, "image": "images/novotech/135151.png" }
    };

    /***** Встроенные данные для NOVOTECH *****/
    var products = {
      "novotech": {
        "black": {
          "surface": {
            // Доступны только варианты 1м и 2м
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135136"] },  // 1м черный
              { "min": 101, "max": 200, "items": ["135138"] }   // 2м черный
            ],
            "connectors": {
              "straight": ["135140"],  // прямой черный
              "L-shape": ["135142"],   // угловой черный
              "T-shape": ["135144"],   // Т-образный черный
              "x": []                  // для X-образной системы – обработаем отдельно
            },
            "components": {
              "135136": { "name": "Шинопровод накладной черный 1м (135136)", "price": 960, "image": "images/novotech/135136.png" },
              "135138": { "name": "Шинопровод накладной черный 2м (135138)", "price": 1920, "image": "images/novotech/135138.png" },
              "135140": { "name": "Коннектор прямой черный (135140)", "price": 250, "image": "images/novotech/135140.png" },
              "135142": { "name": "Коннектор угловой черный (135142)", "price": 250, "image": "images/novotech/135142.png" },
              "135144": { "name": "Коннектор Т-образный черный (135144)", "price": 350, "image": "images/novotech/135144.png" }
            }
          },
          "hanging": {
            // Для подвесного монтажа используются те же данные, что и для surface
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135136"] },
              { "min": 101, "max": 200, "items": ["135138"] }
            ],
            "connectors": {
              "straight": ["135140"],
              "L-shape": ["135142"],
              "T-shape": ["135144"],
              "x": []
            },
            "components": {
              "135136": { "name": "Шинопровод накладной черный 1м (135136)", "price": 960, "image": "images/novotech/135136.png" },
              "135138": { "name": "Шинопровод накладной черный 2м (135138)", "price": 1920, "image": "images/novotech/135138.png" },
              "135140": { "name": "Коннектор прямой черный (135140)", "price": 250, "image": "images/novotech/135140.png" },
              "135142": { "name": "Коннектор угловой черный (135142)", "price": 250, "image": "images/novotech/135142.png" },
              "135144": { "name": "Коннектор Т-образный черный (135144)", "price": 350, "image": "images/novotech/135144.png" }
            }
          },
          "stretch-ceiling": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135136"] },
              { "min": 101, "max": 200, "items": ["135138"] }
            ],
            "connectors": {
              "straight": ["135140"],
              "L-shape": ["135142"],
              "T-shape": ["135144"],
              "x": []
            },
            "components": {
              "135136": { "name": "Шинопровод накладной черный 1м (135136)", "price": 960, "image": "images/novotech/135136.png" },
              "135138": { "name": "Шинопровод накладной черный 2м (135138)", "price": 1920, "image": "images/novotech/135138.png" },
              "135140": { "name": "Коннектор прямой черный (135140)", "price": 250, "image": "images/novotech/135140.png" },
              "135142": { "name": "Коннектор угловой черный (135142)", "price": 250, "image": "images/novotech/135142.png" },
              "135144": { "name": "Коннектор Т-образный черный (135144)", "price": 350, "image": "images/novotech/135144.png" }
            }
          },
          "recessed": {
            // Для встраиваемого монтажа – базовые данные, как surface
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135136"] },
              { "min": 101, "max": 200, "items": ["135138"] }
            ],
            "connectors": {
              "straight": ["135140"],
              "L-shape": ["135142"],
              "T-shape": ["135144"],
              "x": []
            },
            "components": {
              "135136": { "name": "Шинопровод накладной черный 1м (135136)", "price": 960, "image": "images/novotech/135136.png" },
              "135138": { "name": "Шинопровод накладной черный 2м (135138)", "price": 1920, "image": "images/novotech/135138.png" },
              "135140": { "name": "Коннектор прямой черный (135140)", "price": 250, "image": "images/novotech/135140.png" },
              "135142": { "name": "Коннектор угловой черный (135142)", "price": 250, "image": "images/novotech/135142.png" },
              "135144": { "name": "Коннектор Т-образный черный (135144)", "price": 350, "image": "images/novotech/135144.png" }
            }
          }
        },
        "white": {
          "surface": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135135"] },  // 1м белый
              { "min": 101, "max": 200, "items": ["135137"] }   // 2м белый
            ],
            "connectors": {
              "straight": ["135139"],  // прямой белый
              "L-shape": ["135141"],   // угловой белый
              "T-shape": ["135143"],   // Т-образный белый
              "x": []
            },
            "components": {
              "135135": { "name": "Шинопровод накладной белый 1м (135135)", "price": 960, "image": "images/novotech/135135.png" },
              "135137": { "name": "Шинопровод накладной белый 2м (135137)", "price": 1920, "image": "images/novotech/135137.png" },
              "135139": { "name": "Коннектор прямой белый (135139)", "price": 250, "image": "images/novotech/135139.png" },
              "135141": { "name": "Коннектор угловой белый (135141)", "price": 250, "image": "images/novotech/135141.png" },
              "135143": { "name": "Коннектор Т-образный белый (135143)", "price": 350, "image": "images/novotech/135143.png" }
            }
          },
          "hanging": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135135"] },
              { "min": 101, "max": 200, "items": ["135137"] }
            ],
            "connectors": {
              "straight": ["135139"],
              "L-shape": ["135141"],
              "T-shape": ["135143"],
              "x": []
            },
            "components": {
              "135135": { "name": "Шинопровод накладной белый 1м (135135)", "price": 960, "image": "images/novotech/135135.png" },
              "135137": { "name": "Шинопровод накладной белый 2м (135137)", "price": 1920, "image": "images/novotech/135137.png" },
              "135139": { "name": "Коннектор прямой белый (135139)", "price": 250, "image": "images/novotech/135139.png" },
              "135141": { "name": "Коннектор угловой белый (135141)", "price": 250, "image": "images/novotech/135141.png" },
              "135143": { "name": "Коннектор Т-образный белый (135143)", "price": 350, "image": "images/novotech/135143.png" }
            }
          },
          "stretch-ceiling": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135135"] },
              { "min": 101, "max": 200, "items": ["135137"] }
            ],
            "connectors": {
              "straight": ["135139"],
              "L-shape": ["135141"],
              "T-shape": ["135143"],
              "x": []
            },
            "components": {
              "135135": { "name": "Шинопровод накладной белый 1м (135135)", "price": 960, "image": "images/novotech/135135.png" },
              "135137": { "name": "Шинопровод накладной белый 2м (135137)", "price": 1920, "image": "images/novotech/135137.png" },
              "135139": { "name": "Коннектор прямой белый (135139)", "price": 250, "image": "images/novotech/135139.png" },
              "135141": { "name": "Коннектор угловой белый (135141)", "price": 250, "image": "images/novotech/135141.png" },
              "135143": { "name": "Коннектор Т-образный белый (135143)", "price": 350, "image": "images/novotech/135143.png" }
            }
          },
          "recessed": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["135135"] },
              { "min": 101, "max": 200, "items": ["135137"] }
            ],
            "connectors": {
              "straight": ["135139"],
              "L-shape": ["135141"],
              "T-shape": ["135143"],
              "x": []
            },
            "components": {
              "135135": { "name": "Шинопровод накладной белый 1м (135135)", "price": 960, "image": "images/novotech/135135.png" },
              "135137": { "name": "Шинопровод накладной белый 2м (135137)", "price": 1920, "image": "images/novotech/135137.png" },
              "135139": { "name": "Коннектор прямой белый (135139)", "price": 250, "image": "images/novotech/135139.png" },
              "135141": { "name": "Коннектор угловой белый (135141)", "price": 250, "image": "images/novotech/135141.png" },
              "135143": { "name": "Коннектор Т-образный белый (135143)", "price": 350, "image": "images/novotech/135143.png" }
            }
          }
        }
      }
    };
    
    /***** Дополнительные данные для NOVOTECH (новые компоненты) *****/
    var additionalMappingNovotech = {
      // X-коннекторы
      "135145": { "name": "Х-коннектор белый (135145)", "price": 420, "image": "images/novotech/135145.png" },
      "135146": { "name": "Х-коннектор черный (135146)", "price": 420, "image": "images/novotech/135146.png" },
      // Профили для натяжного потолка (2м)
      "135192": { "name": "Профиль для натяжного потолка белый 2м (135192)", "price": 6400, "image": "images/novotech/135192.png" },
      "135191": { "name": "Профиль для натяжного потолка черный 2м (135191)", "price": 6400, "image": "images/novotech/135191.png" },
      // Заглушки для натяжного потолка
      "135188": { "name": "Заглушка для профиля белая (135188)", "price": 1100, "image": "images/novotech/135188.png" },
      "135187": { "name": "Заглушка для профиля черная (135187)", "price": 1100, "image": "images/novotech/135187.png" },
      // Встраиваемый профиль 1м
      "358090": { "name": "Встраиваемый профиль 1м (358090)", "price": 1000, "image": "images/novotech/358090.png" },
      // Соединитель для встраиваемого профиля
      "358233": { "name": "Соединитель для встраиваемого профиля (358233)", "price": 99, "image": "images/novotech/358233.png" }
    };
    
    /***** Функции расчёта трековых сегментов для NOVOTECH *****/
    function getTracksForNovotech(legLength, lengthOptions) {
      let pieces = [];
      if (legLength % 400 === 0) {
        let count = legLength / 200;
        for (let i = 0; i < count; i++) {
          pieces.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
        }
        return pieces;
      }
      if (legLength <= 100) {
        pieces.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
      } else if (legLength <= 200) {
        pieces.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
      } else {
        let fullPieces = Math.floor(legLength / 200);
        for (let i = 0; i < fullPieces; i++) {
          pieces.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
        }
        let remainder = legLength - fullPieces * 200;
        if (remainder > 0) {
          if (remainder <= 100) {
            pieces.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
          } else {
            pieces.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
          }
        }
      }
      return pieces;
    }
    function getTracksForNovotechSurface(legLength, lengthOptions) {
      return getTracksForNovotech(legLength, lengthOptions);
    }
    function getTracksForNovotechHanging(legLength, lengthOptions) {
      return getTracksForNovotech(legLength, lengthOptions);
    }
    
    // Функция для определения номинальной длины трека по его id для NOVOTECH.
    function getNominalLength(id) {
      if (id === "135136" || id === "135135") return 100;
      if (id === "135138" || id === "135137") return 200;
      return null;
    }
    
    function wrapConnector(conn) {
      return (typeof conn === "object" && conn !== null && conn.id !== undefined) ? conn : { id: conn };
    }
    
    // Функция проверки режима монтажа для NOVOTECH – теперь доступны surface, hanging, stretch‑ceiling и recessed.
    function checkMountingForNovotech(mountingParam) {
      if (["surface", "hanging", "stretch-ceiling", "recessed"].indexOf(mountingParam) === -1) {
        document.getElementById("resultContainer").style.display = "none";
        document.getElementById("debug").textContent = "Для NOVOTECH доступны режимы: surface, hanging, stretch‑ceiling и recessed.";
        return false;
      }
      return true;
    }
    
    window.safeShowSelection = function() {
      try {
        showSelection();
      } catch (e) {
        console.error("Ошибка в showSelection:", e);
        alert("Произошла ошибка при подборе. Проверьте консоль для подробностей.");
      }
    };
    
    /***** Основная функция подбора для NOVOTECH *****/
    window.showSelection = function() {
      console.log("Начало работы showSelection (NOVOTECH)");
    
      const params = new URLSearchParams(window.location.search);
      // Для NOVOTECH используем тип "novotech"
      const type = "novotech";
      const color = params.get("color") || "black";
      let mountingParam = params.get("mounting") || "surface";
      
      if (!checkMountingForNovotech(mountingParam)) return;
      
      const shape = params.get("shape") || "straight";
      const lengthA = parseFloat(params.get("lengthA")) || 150;
      const lengthB = parseFloat(params.get("lengthB")) || 0;
    
      console.log("Параметры подбора (NOVOTECH):", { type, color, mounting: mountingParam, shape, lengthA, lengthB });
    
      // Для NOVOTECH базовые треки берём из "surface" если mountingParam не равен "hanging", иначе остаётся surface
      let effectiveProduct = (mountingParam === "hanging" || mountingParam === "stretch-ceiling") ?
          (products.novotech && products.novotech[color] && products.novotech[color]["surface"]) :
          (products.novotech && products.novotech[color] && products.novotech[color][mountingParam]) ||
          (products.novotech && products.novotech[color] && products.novotech[color]["surface"]);
      if (!effectiveProduct) {
        throw new Error("Не найден комплект для NOVOTECH с выбранными параметрами.");
      }
    
      let components = effectiveProduct.components;
      const lengthOptions = effectiveProduct.lengthOptions;
      let selectedItems = [];
      let usedConnectors = [];
    
      // Расчёт трековых сегментов по фигурам:
      if (shape === "straight") {
        selectedItems = (mountingParam === "hanging") ?
                        getTracksForNovotechHanging(lengthA, lengthOptions) :
                        getTracksForNovotechSurface(lengthA, lengthOptions);
      }
      else if (shape === "L-shape") {
        let legATracks = getTracksForNovotech(lengthA, lengthOptions);
        let legBTracks = getTracksForNovotech(lengthB, lengthOptions);
        selectedItems = legATracks.concat(legBTracks);
        if (effectiveProduct.connectors["L-shape"] && effectiveProduct.connectors["L-shape"].length > 0) {
          usedConnectors.push(wrapConnector(effectiveProduct.connectors["L-shape"][0]));
        }
        if (legATracks.length > 1) {
          for (let i = 0; i < legATracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
        if (legBTracks.length > 1) {
          for (let i = 0; i < legBTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
      }
      else if (shape === "T-shape") {
        let topTracks = getTracksForNovotech(lengthA, lengthOptions);
        let verticalTracks = getTracksForNovotech(lengthB, lengthOptions);
        selectedItems = topTracks.concat(verticalTracks);
        if (effectiveProduct.connectors["T-shape"] && effectiveProduct.connectors["T-shape"].length > 0) {
          usedConnectors.push(wrapConnector(effectiveProduct.connectors["T-shape"][0]));
        }
        if (topTracks.length > 1) {
          for (let i = 0; i < topTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
        if (verticalTracks.length > 1) {
          for (let i = 0; i < verticalTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
      }
      else if (shape === "P-shape") {
        let sideTracks = getTracksForNovotech(lengthA, lengthOptions);
        let connectingTracks = getTracksForNovotech(lengthB, lengthOptions);
        selectedItems = sideTracks.concat(sideTracks, connectingTracks);
        if (effectiveProduct.connectors["L-shape"] && effectiveProduct.connectors["L-shape"].length > 0) {
          usedConnectors.push(wrapConnector(effectiveProduct.connectors["L-shape"][0]));
          usedConnectors.push(wrapConnector(effectiveProduct.connectors["L-shape"][0]));
        }
        if (sideTracks.length > 1) {
          for (let i = 0; i < sideTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
        if (connectingTracks.length > 1) {
          for (let i = 0; i < connectingTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
      }
      else if (shape === "rectangle") {
        let tracksA = getTracksForNovotech(lengthA, lengthOptions);
        let tracksB = getTracksForNovotech(lengthB, lengthOptions);
        selectedItems = tracksA.concat(tracksA, tracksB, tracksB);
        if (effectiveProduct.connectors["L-shape"] && effectiveProduct.connectors["L-shape"].length > 0) {
          for (let i = 0; i < 4; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors["L-shape"][0]));
          }
        }
        let straightForA = (tracksA.length > 1) ? 2 * (tracksA.length - 1) : 0;
        let straightForB = (tracksB.length > 1) ? 2 * (tracksB.length - 1) : 0;
        for (let i = 0; i < straightForA + straightForB; i++) {
          usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
        }
      }
      else if (shape === "x") {
        // X‑образная система: как в L-shape, но заменяем угловой коннектор на X-коннектор
        let legATracks = getTracksForNovotech(lengthA, lengthOptions);
        let legBTracks = getTracksForNovotech(lengthB, lengthOptions);
        selectedItems = legATracks.concat(legBTracks);
        // Выбираем X-коннектор в зависимости от режима монтажа:
        // Для recessed (встраиваемый) используем: black – 135146, white – 135145
        // Для остальных режимов оставляем коннекторы как для L-shape (либо можно задать отдельно)
        let xConnector;
        if (mountingParam === "recessed") {
          xConnector = (color === "black") ? "135146" : "135145";
        } else {
          xConnector = (color === "black") ? "135142" : "135141";
        }
        usedConnectors.push(wrapConnector(xConnector));
        if (legATracks.length > 1) {
          for (let i = 0; i < legATracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
        if (legBTracks.length > 1) {
          for (let i = 0; i < legBTracks.length - 1; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
      }
      else {
        throw new Error("Логика для фигуры '" + shape + "' не реализована для NOVOTECH.");
      }
      
      // Для систем "straight" – добавляем недостающие прямые коннекторы, если они не были добавлены
      if (shape === "straight") {
        let trackPieces = selectedItems.filter(item => item.hasOwnProperty("pieceLength"));
        let neededStraight = (trackPieces.length > 1) ? trackPieces.length - 1 : 0;
        let currentStraight = usedConnectors.filter(conn => conn.id === effectiveProduct.connectors.straight[0]).length;
        let missing = neededStraight - currentStraight;
        if (missing > 0) {
          for (let i = 0; i < missing; i++) {
            usedConnectors.push(wrapConnector(effectiveProduct.connectors.straight[0]));
          }
        }
      }
      
      console.log("Подобранные треки (до доп. компонентов):", selectedItems);
      
      /***** Добавление выбранных светильников *****/
      // Если параметр "lights" передан (как JSON-массив), парсим его и добавляем соответствующие светильники
      let lightsParam = params.get("lights");
      if (lightsParam) {
        try {
          let lightingOptions = JSON.parse(lightsParam);
          lightingOptions.forEach(light => {
            // Приводим цвет к нижнему регистру
            let col = color.toLowerCase();
            // Здесь используем переменную lightingMappingMaytoni, которая должна быть определена
            // Если её нет, можно объявить её ниже
            if (typeof lightingMappingMaytoni === "undefined") {
              var lightingMappingMaytoni = {
                "spot": {
                  "black": { id: "TR020-1-GU10-B", name: "Трековый светильник Focus S черный (TR020-1-GU10-B)", price: 1690, image: "images/novotech/TR020-1-GU10-B.png" },
                  "white": { id: "TR020-1-GU10-W", name: "Трековый светильник Focus S белый (TR020-1-GU10-W)", price: 1690, image: "images/novotech/TR020-1-GU10-W.png" }
                },
                "linear": {
                  "black": { id: "TR000-1-12W4K-B", name: "Линейный светильник черный (TR000-1-12W4K-B)", price: 4390, image: "images/novotech/TR000-1-12W4K-B.png" },
                  "white": { id: "TR000-1-12W4K-W", name: "Линейный светильник белый (TR000-1-12W4K-W)", price: 4390, image: "images/novotech/TR000-1-12W4K-W.png" }
                },
                "pendant": {
                  "black": { id: "TR025-1-GU10-B", name: "Подвесной светильник черный (TR025-1-GU10-B)", price: 2590, image: "images/novotech/TR025-1-GU10-B.png" },
                  "white": { id: "TR008-1-GU10-W", name: "Подвесной светильник белый (TR008-1-GU10-W)", price: 2600, image: "images/novotech/TR008-1-GU10-W.png" }
                }
              };
            }
            let lightItem = (lightingMappingMaytoni[light.type] && lightingMappingMaytoni[light.type][col]) ? lightingMappingMaytoni[light.type][col] : null;
            if (lightItem) {
              for (let i = 0; i < parseInt(light.quantity); i++) {
                selectedItems.push({ id: lightItem.id });
                if (!components[lightItem.id]) {
                  components[lightItem.id] = {
                    name: lightItem.name,
                    price: lightItem.price,
                    image: lightItem.image
                  };
                }
              }
            }
          });
        } catch (e) {
          console.warn("Невозможно распарсить параметр lights:", e);
        }
      }
      
      /***** Дополнительные компоненты по режимам монтажа *****/
      if (mountingParam === "stretch-ceiling") {
        // Для натяжного потолка: профиль имеет длину 200 см
        // Эффективная длина системы рассчитывается по сумме длин (если фигура не straight – lengthA + lengthB; для straight – lengthA)
        let effectiveTrackLength = 0;
        if (shape === "straight") {
          effectiveTrackLength = lengthA;
        } else if (["L-shape", "T-shape", "P-shape", "x"].includes(shape)) {
          effectiveTrackLength = lengthA + lengthB;
        } else if (shape === "rectangle") {
          effectiveTrackLength = 2 * (lengthA + lengthB);
        } else {
          effectiveTrackLength = lengthA + lengthB;
        }
        console.log("Эффективная длина трековой системы (stretch-ceiling):", effectiveTrackLength, "см");
        let profileCount = Math.ceil(effectiveTrackLength / 200);
        console.log("Профилей для добавления (stretch-ceiling):", profileCount);
        // Добавляем профиль для натяжного потолка (артикул зависит от цвета)
        let profileId = (color === "black") ? "135191" : "135192";
        for (let i = 0; i < profileCount; i++) {
          selectedItems.push({ id: profileId, pieceLength: 200 });
        }
        // Заглушки для натяжного потолка: фиксированное количество в зависимости от фигуры
        let endCapsCount = 0;
        if (shape === "T-shape") {
          endCapsCount = 3;
        } else if (shape === "x") {
          endCapsCount = 4;
        } else if (["straight", "L-shape", "P-shape", "rectangle"].includes(shape)) {
          endCapsCount = 2;
        }
        for (let i = 0; i < endCapsCount; i++) {
          selectedItems.push({ id: (color === "black") ? "135187" : "135188" });
        }
      }
      else if (mountingParam === "recessed") {
        // Для встраиваемой системы: профиль имеет длину 100 см
        let effectiveTrackLength = 0;
        if (shape === "straight") {
          effectiveTrackLength = lengthA;
        } else if (["L-shape", "T-shape", "P-shape", "x"].includes(shape)) {
          effectiveTrackLength = lengthA + lengthB;
        } else if (shape === "rectangle") {
          effectiveTrackLength = 2 * (lengthA + lengthB);
        } else {
          effectiveTrackLength = lengthA + lengthB;
        }
        console.log("Эффективная длина трековой системы (recessed):", effectiveTrackLength, "см");
        let profileCount = Math.ceil(effectiveTrackLength / 100);
        console.log("Встраиваемых профилей для добавления (recessed):", profileCount);
        for (let i = 0; i < profileCount; i++) {
          selectedItems.push({ id: "358090", pieceLength: 100 });
        }
        // Для каждого соединения профилей (число профилей - 1) добавляем соединитель 358233
        if (profileCount > 1) {
          let connections = profileCount - 1;
          for (let i = 0; i < connections; i++) {
            selectedItems.push({ id: "358233" });
          }
        }
      }
      
      if (mountingParam === "hanging") {
        let trackLength = selectedItems.reduce((sum, item) => sum + (item.pieceLength || 0), 0);
        let suspCount = Math.max(2, 1 + Math.ceil(trackLength / 200));
        console.log("Общая длина треков (hanging):", trackLength, "см, подвесов для добавления:", suspCount);
        let suspensionId = (color === "black") ? "135152" : "135151";
        for (let i = 0; i < suspCount; i++) {
          selectedItems.push({ id: suspensionId });
        }
      }
      
      console.log("Финальный результат подбора (NOVOTECH):", selectedItems);
      
      /***** Группировка элементов *****/
      let groupedItems = {};
      selectedItems.concat(usedConnectors).forEach(itemObj => {
        let id = itemObj.id;
        if (!id) {
          console.warn("Обнаружен элемент без id:", itemObj);
          return;
        }
        let isTrack = itemObj.hasOwnProperty("pieceLength");
        if (!groupedItems[id]) {
          // Ищем описание компонента сначала в products.novotech[color]["surface"].components,
          // затем в suspensionMapping, затем в additionalMappingNovotech
          let comp = (products.novotech[color]["surface"].components[id]) || suspensionMapping[id] || additionalMappingNovotech[id] || {};
          groupedItems[id] = { totalLength: 0, count: 0, component: comp, isTrack: isTrack };
        }
        if (isTrack) {
          groupedItems[id].totalLength += itemObj.pieceLength;
        }
        groupedItems[id].count++;
      });
      console.log("Сгруппированные элементы (до расчёта итоговых количеств):", groupedItems);
      
      let totalPrice = 0;
      let tbodyHTML = "";
      for (const [id, group] of Object.entries(groupedItems)) {
        let comp = group.component;
        if (comp && comp.name) {
          let qty;
          if (group.isTrack && group.totalLength > 0) {
            let nominal = getNominalLength(id);
            qty = Math.ceil(group.totalLength / nominal);
          } else {
            qty = group.count;
          }
          let cost = qty * comp.price;
          totalPrice += cost;
          tbodyHTML += `
            <tr>
              <td><img src="images/novotech/${id}.png" alt="${comp.name}" style="width:50px; height:auto; margin-right:10px;">${comp.name} ${id}</td>
              <td style="background-color: white; text-align: center;">${qty} шт.</td>
              <td>${comp.price}₽</td>
              <td>${cost}₽</td>
            </tr>
          `;
        } else {
          console.warn("Компонент с ID " + id + " не найден или не имеет имени.");
        }
      }
      
      document.getElementById("results").innerHTML = tbodyHTML;
      document.getElementById("totalPrice").innerHTML = `<div>Итого: ${totalPrice}₽</div>`;
      document.getElementById("resultContainer").style.display = "block";
      console.log("Подбор завершён успешно (NOVOTECH).");
    };
    
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(window.safeShowSelection, 1000);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Maytoni UNITY – Подбор трековой системы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Общие стили для maytoni.html */
    html, body {
      margin: 0;
      padding: 0;
      background-color: #e7f5fd;
      overflow: visible;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background-color: white;
      padding: 20px;
      border: 1px solid #ddd;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      height: auto;
      overflow: visible;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      table-layout: auto;
    }
    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
      font-size: 13px;
    }
    .results-table th {
      background-color: #f4f4f4;
      font-weight: bold;
    }
    .results-table th:nth-child(3),
    .results-table td:nth-child(3) {
      width: 90px;
    }
    .results-table th:nth-child(2),
    .results-table td:nth-child(2) {
      width: 40px;
      text-align: center;
    }
    .total-price {
      font-weight: bold;
      text-align: right;
      margin-top: 10px;
      font-size: 14px;
    }
    .result-container {
      display: none;
      overflow: visible;
    }
    .debug {
      font-size: 12px;
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Контейнер для вывода результатов подбора -->
    <div id="resultContainer" class="result-container">
      <table class="results-table" id="resultsTable">
        <thead id="tableHeader">
          <tr>
            <th>Наименование</th>
            <th>кол.</th>
            <th>Цена за шт.</th>
            <th>Общая цена</th>
          </tr>
        </thead>
        <tbody id="results">
          <!-- Здесь будут выводиться результаты подбора -->
        </tbody>
      </table>
      <div id="totalPrice" class="total-price"></div>
    </div>
    <!-- Отладочный блок (при необходимости) -->
    <div id="debug" class="debug"></div>
  </div>
  
  <script>
    /***** Встроенные данные о продуктах *****/
    var products = {
      "one-phase": {
        "black": {
          "surface": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX001-111B"] },
              { "min": 101, "max": 200, "items": ["TRX001-112B"] },
              { "min": 201, "max": 300, "items": ["TRX001-113B"] }
            ],
            "connectors": {
              "straight": ["TRA001C-11B"],
              "L-shape": ["TRA001CL-11B"],
              "T-shape": ["TRA001CT-11B"]
            },
            "components": {
              "TRX001-111B": { "name": "Шинопровод накладной черный 1м TRX001-111B", "price": 1500, "image": "images/TRX001-111B.png" },
              "TRX001-112B": { "name": "Шинопровод накладной черный 2м TRX001-112B", "price": 2500, "image": "images/TRX001-112B.png" },
              "TRX001-113B": { "name": "Шинопровод накладной черный 3м TRX001-113B", "price": 3490, "image": "images/TRX001-113B.png" },
              "TRA001C-11B": { "name": "Коннектор прямой черный TRA001C-11B", "price": 100, "image": "images/TRA001C-11B.png" },
              "TRA001CL-11B": { "name": "Коннектор угловой черный TRA001CL-11B", "price": 150, "image": "images/TRA001CL-11B.png" },
              "TRA001CT-11B": { "name": "Коннектор Т-образный черный TRA001CT-11B", "price": 200, "image": "images/TRA001CT-11B.png" },
              "TRA001MP-112S": { "name": "Профиль для натяжного потолка TRA001MP-112S", "price": 300, "image": "images/TRA001MP-112S.png" }
            }
          },
          "recessed": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX004-111B"] },
              { "min": 101, "max": 200, "items": ["TRX004-112B"] }
            ],
            "connectors": {
              "straight": ["TRA002C-11B"],
              "L-shape": ["TRA002CL-11B"],
              "T-shape": ["TRA002CT-11B"]
            },
            "components": {
              "TRX004-111B": { "name": "Шинопровод встраиваемый черный 1м TRX004-111B", "price": 1600, "image": "images/TRX004-111B.png" },
              "TRX004-112B": { "name": "Шинопровод встраиваемый черный 2м TRX004-112B", "price": 2600, "image": "images/TRX004-112B.png" },
              "TRA002C-11B": { "name": "Коннектор прямой черный для встраивания TRA002C-11B", "price": 110, "image": "images/TRA002C-11B.png" },
              "TRA002CL-11B": { "name": "Коннектор угловой черный для встраивания TRA002CL-11B", "price": 160, "image": "images/TRA002CL-11B.png" },
              "TRA002CT-11B": { "name": "Коннектор Т-образный черный для встраивания TRA002CT-11B", "price": 210, "image": "images/TRA002CT-11B.png" }
            }
          },
          "stretch-ceiling": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX003-111B"] },
              { "min": 101, "max": 200, "items": ["TRX003-112B"] },
              { "min": 201, "max": 300, "items": ["TRX003-113B"] }
            ],
            "connectors": {
              "straight": ["TRA003C-11B"],
              "L-shape": ["TRA003CL-11B"],
              "T-shape": ["TRA003CT-11B"]
            },
            "additionalComponents": ["TRA001MP-112S"],
            "components": {
              "TRA001MP-112S": { "name": "Профиль для натяжного потолка TRA001MP-112S", "price": 300, "image": "images/TRA001MP-112S.png" }
            }
          }
        },
        "white": {
          "surface": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX001-111W"] },
              { "min": 101, "max": 200, "items": ["TRX001-112W"] },
              { "min": 201, "max": 300, "items": ["TRX001-113W"] }
            ],
            "connectors": {
              "straight": ["TRA001C-11W"],
              "L-shape": ["TRA001CL-11W"],
              "T-shape": ["TRA001CT-11W"]
            },
            "components": {
              "TRX001-111W": { "name": "Шинопровод накладной белый 1м TRX001-111W", "price": 1550, "image": "images/TRX001-111W.png" },
              "TRX001-112W": { "name": "Шинопровод накладной белый 2м TRX001-112W", "price": 2550, "image": "images/TRX001-112W.png" },
              "TRX001-113W": { "name": "Шинопровод накладной белый 3м TRX001-113W", "price": 3550, "image": "images/TRX001-113W.png" },
              "TRA001C-11W": { "name": "Коннектор прямой белый TRA001C-11W", "price": 105, "image": "images/TRA001C-11W.png" },
              "TRA001CL-11W": { "name": "Коннектор угловой белый TRA001CL-11W", "price": 155, "image": "images/TRA001CL-11W.png" },
              "TRA001CT-11W": { "name": "Коннектор Т-образный белый TRA001CT-11W", "price": 205, "image": "images/TRA001CT-11W.png" },
              "TRA001MP-112S": { "name": "Профиль для натяжного потолка TRA001MP-112S", "price": 300, "image": "images/TRA001MP-112S.png" }
            }
          },
          "recessed": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX004-111W"] },
              { "min": 101, "max": 200, "items": ["TRX004-112W"] }
            ],
            "connectors": {
              "straight": ["TRA002C-11W"],
              "L-shape": ["TRA002CL-11W"],
              "T-shape": ["TRA002CT-11W"]
            },
            "components": {
              "TRX004-111W": { "name": "Шинопровод встраиваемый белый 1м TRX004-111W", "price": 1650, "image": "images/TRX004-111W.png" },
              "TRX004-112W": { "name": "Шинопровод встраиваемый белый 2м TRX004-112W", "price": 2650, "image": "images/TRX004-112W.png" },
              "TRA002C-11W": { "name": "Коннектор прямой белый для встраивания TRA002C-11W", "price": 115, "image": "images/TRA002C-11W.png" },
              "TRA002CL-11W": { "name": "Коннектор угловой белый для встраивания TRA002CL-11W", "price": 165, "image": "images/TRA002CL-11W.png" },
              "TRA002CT-11W": { "name": "Коннектор Т-образный белый для встраивания TRA002CT-11W", "price": 215, "image": "images/TRA002CT-11W.png" }
            }
          },
          "stretch-ceiling": {
            "lengthOptions": [
              { "min": 0, "max": 100, "items": ["TRX003-111W"] },
              { "min": 101, "max": 200, "items": ["TRX003-112W"] },
              { "min": 201, "max": 300, "items": ["TRX003-113W"] }
            ],
            "connectors": {
              "straight": ["TRA003C-11W"],
              "L-shape": ["TRA003CL-11W"],
              "T-shape": ["TRA003CT-11W"]
            },
            "additionalComponents": ["TRA001MP-112S"],
            "components": {
              "TRA001MP-112S": { "name": "Профиль для натяжного потолка TRA001MP-112S", "price": 300, "image": "images/TRA001MP-112S.png" }
            }
          }
        }
      }
    };
    /***** Конец встроенных данных *****/

    // Функция для изменения высоты iframe (если понадобится; для maytoni.html не используется)
    window.resizeIframe = function(iframe) {
      try {
        var doc = iframe.contentDocument || iframe.contentWindow.document;
        if (doc && doc.body && doc.body.scrollHeight) {
          iframe.style.height = doc.body.scrollHeight + "px";
        }
      } catch (e) {
        console.error("Ошибка при изменении высоты iframe:", e);
      }
    };

    // Глобальная функция safeShowSelection – вызывается из родительского документа, если требуется
    window.safeShowSelection = function() {
      try {
        showSelection();
      } catch (e) {
        console.error("Ошибка в showSelection:", e);
        alert("Произошла ошибка при подборе. Проверьте консоль для подробностей.");
      }
    };

    // Функция подбора для Maytoni UNITY (логика для фигуры "straight")
    window.showSelection = function() {
      console.log("Начало работы showSelection");

      // Считываем параметры из URL или используем значения по умолчанию
      const params = new URLSearchParams(window.location.search);
      const type = params.get("type") || "one-phase";
      const color = params.get("color") || "black";
      let mountingParam = params.get("mounting") || "surface";
      const shape = params.get("shape") || "straight";
      const lengthA = parseFloat(params.get("lengthA")) || 150;
      const lengthB = parseFloat(params.get("lengthB")) || 0;

      // Для Maytoni UNITY используем комплект "surface"
      const mounting = mountingParam;
      console.log("Параметры подбора:", { type, color, mounting, shape, lengthA, lengthB });

      // Находим выбранный продукт
      const selectedProduct = products[type] && products[type][color] && products[type][color][mounting];
      if (!selectedProduct) {
        throw new Error("Не найден комплект для выбранных параметров.");
      }

      // Если режим stretch-ceiling, объединяем компоненты из блока "stretch-ceiling"
      let components = selectedProduct.components;
      if (mountingParam === "stretch-ceiling") {
        const ceilingProduct = products[type][color]["stretch-ceiling"];
        components = Object.assign({}, components, ceilingProduct.components);
      }

      const lengthOptions = selectedProduct.lengthOptions;

      // Для фигуры "straight" используем только lengthA
      let totalLength = (shape === "straight") ? lengthA : (lengthA + lengthB);
      console.log("Общая требуемая длина:", totalLength, "см");

      // Логика подбора для прямой системы:
      // Если mounting = "surface": доступны элементы 100, 200, 300 см.
      // Если требуемая длина <=100, выбираем 1м; <=200, 2м; <=300, 3м.
      // Если больше 300 см, используем один 3м, затем добавляем 1м элементы до достижения или превышения требуемой длины.
      let selectedItems = [];
      let provided = 0;
      if (shape === "straight") {
        if (mounting === "surface") {
          if (totalLength <= 100) {
            selectedItems.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
            provided = 100;
          } else if (totalLength <= 200) {
            selectedItems.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
            provided = 200;
          } else if (totalLength <= 300) {
            selectedItems.push({ id: lengthOptions[2].items[0], pieceLength: 300 });
            provided = 300;
          } else {
            // Если требуется больше 300 см: обязательно один 3м, затем добавляем 1м элементы
            selectedItems.push({ id: lengthOptions[2].items[0], pieceLength: 300 });
            provided = 300;
            while (provided < totalLength) {
              selectedItems.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
              provided += 100;
            }
          }
        } else if (mounting === "recessed") {
          // Для встраиваемой системы доступны только 1м и 2м элементы
          if (totalLength <= 100) {
            selectedItems.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
            provided = 100;
          } else if (totalLength <= 200) {
            selectedItems.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
            provided = 200;
          } else {
            // Если требуется больше 200 см: используем комбинацию 2м и 1м элементов
            while (provided < totalLength) {
              let rem = totalLength - provided;
              if (rem > 100) {
                selectedItems.push({ id: lengthOptions[1].items[0], pieceLength: 200 });
                provided += 200;
              } else {
                selectedItems.push({ id: lengthOptions[0].items[0], pieceLength: 100 });
                provided += 100;
              }
            }
          }
        }
      } else {
        // Если не прямая система – можно добавить расширенную логику для других фигур
        throw new Error("Логика для фигуры '" + shape + "' не реализована.");
      }
      console.log("Подобранные треки:", selectedItems);

      // Если более одного элемента, добавляем прямой коннектор между ними
      let usedConnectors = [];
      if (selectedItems.length > 1) {
        for (let i = 0; i < selectedItems.length - 1; i++) {
          usedConnectors.push(selectedProduct.connectors.straight[0]);
        }
      }

      // Группируем трековые элементы и коннекторы
      let groupedItems = {};
      selectedItems.concat(usedConnectors).forEach(itemObj => {
        const id = itemObj.id;
        if (!groupedItems[id]) {
          groupedItems[id] = { count: 0, component: components[id] };
        }
        groupedItems[id].count++;
      });
      console.log("Сгруппированные элементы:", groupedItems);

      // Формируем HTML для таблицы результатов
      let tbodyHTML = "";
      let totalPrice = 0;
      for (const [id, itemData] of Object.entries(groupedItems)) {
        const comp = itemData.component;
        if (comp) {
          totalPrice += comp.price * itemData.count;
          tbodyHTML += `
            <tr>
              <td><img src="${comp.image}" alt="" style="width:50px; height:auto; margin-right:10px;">${comp.name}</td>
              <td style="background-color: white; text-align: center;">${itemData.count} шт.</td>
              <td>${comp.price}р</td>
              <td>${comp.price * itemData.count}р</td>
            </tr>
          `;
        } else {
          console.warn("Компонент с ID " + id + " не найден.");
        }
      }

      document.getElementById("results").innerHTML = tbodyHTML;
      document.getElementById("totalPrice").innerHTML = `<div>Итого: ${totalPrice}р</div>`;
      document.getElementById("resultContainer").style.display = "block";
      console.log("Подбор завершён успешно.");
    };

    // Автоматический запуск (если требуется)
    document.addEventListener("DOMContentLoaded", function() {
      setTimeout(window.safeShowSelection, 1000);
    });
  </script>
</body>
</html>
